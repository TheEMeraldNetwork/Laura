// Configurazione iniziale
const collaboratori = ['Fedrigo', 'Capogrossi', 'Licordari'];
let tableData = Array(20).fill(null).map(() => ({
    date: '',
    collaboratore: '',
    status: '',
    criticita: '',
    nextSteps: ''
}));

// Inizializza date picker
function initializeDatePicker() {
    flatpickr("#dateSelector", {
        dateFormat: "Y-m-d",
        locale: "it",
        altInput: true,
        altFormat: "d/m/Y",
        minDate: "today"
    });
}

// Popolamento collaboratori
function renderCollaboratori() {
    const container = document.getElementById('collaboratoriList');
    container.innerHTML = collaboratori.map(nome => `
        <div class="p-4 border rounded-md bg-gray-50">
            <span class="font-medium">${nome}</span>
        </div>
    `).join('');

    // Popola anche i dropdown
    const selects = document.querySelectorAll('.collaboratore-select');
    selects.forEach(select => {
        select.innerHTML = `
            <option value="">Seleziona collaboratore</option>
            ${collaboratori.map(nome => `
                <option value="${nome}">${nome}</option>
            `).join('')}
        `;
    });
}

// Genera file .ics per Outlook
function generateOutlookFile() {
    const date = document.getElementById('dateSelector').value;
    const person = document.getElementById('selectPerson').value;
    const time = document.getElementById('selectTime').value;
    
    if (!date || !person || !time) {
        alert('Seleziona data, persona e orario');
        return;
    }

    const [hours, minutes] = time.split(':');
    const dateObj = new Date(date);
    const endDateObj = new Date(dateObj);
    endDateObj.setHours(endDateObj.getHours() + 1);

    const formatDate = (date) => {
        return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    };

    const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Dashboard Laura//IT
BEGIN:VEVENT
DTSTART:${formatDate(dateObj)}
DTEND:${formatDate(endDateObj)}
SUMMARY:Allineamento d'area con ${person}
DESCRIPTION:Incontro di allineamento d'area
ORGANIZER;CN=Laura:mailto:laura@example.com
ATTENDEE;CN=${person}:mailto:${person.toLowerCase()}@example.com
END:VEVENT
END:VCALENDAR`;

    const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `allineamento-${person}-${date}.ics`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
}

// Renderizza tabella
function renderTable() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = tableData.map((row, index) => `
        <tr class="border-t">
            <td class="px-4 py-2 border">
                <input type="text" 
                    class="datepicker w-full p-1 border rounded"
                    value="${row.date}"
                    data-index="${index}"
                    data-field="date">
            </td>
            <td class="px-4 py-2 border">
                <select class="collaboratore-select w-full p-1 border rounded" 
                    data-index="${index}" 
                    data-field="collaboratore">
                    <option value="">Seleziona</option>
                    ${collaboratori.map(nome => `
                        <option value="${nome}" ${row.collaboratore === nome ? 'selected' : ''}>
                            ${nome}
                        </option>
                    `).join('')}
                </select>
            </td>
            <td class="px-4 py-2 border">
                <textarea class="w-full p-1 border rounded" 
                    data-index="${index}" 
                    data-field="status">${row.status}</textarea>
            </td>
            <td class="px-4 py-2 border">
                <textarea class="w-full p-1 border rounded" 
                    data-index="${index}" 
                    data-field="criticita">${row.criticita}</textarea>
            </td>
            <td class="px-4 py-2 border">
                <textarea class="w-full p-1 border rounded" 
                    data-index="${index}" 
                    data-field="nextSteps">${row.nextSteps}</textarea>
            </td>
        </tr>
    `).join('');

    // Inizializza date picker per ogni input data
    document.querySelectorAll('.datepicker').forEach(input => {
        flatpickr(input, {
            dateFormat: "Y-m-d",
            locale: "it",
            altFormat: "d/m/Y"
        });
    });

    // Aggiungi event listeners per il salvataggio
    tbody.querySelectorAll('textarea, select, input').forEach(element => {
        element.addEventListener('change', handleDataChange);
    });
}

// Gestione cambiamenti dati
async function handleDataChange(event) {
    const { index, field } = event.target.dataset;
    const value = event.target.value;
    
    tableData[index][field] = value;
    await saveToFirebase();
}

// Salvataggio su Firebase
async function saveToFirebase() {
    try {
        await setDoc(doc(db, 'dashboard', 'status'), {
            tableData,
            lastUpdate: new Date().toISOString()
        });
    } catch (error) {
        console.error("Errore nel salvataggio:", error);
        alert('Errore nel salvataggio dei dati');
    }
}

// Caricamento da Firebase
async function loadFromFirebase() {
    try {
        const docRef = doc(db, 'dashboard', 'status');
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            const data = docSnap.data();
            tableData = data.tableData;
            renderTable();
        }
    } catch (error) {
        console.error("Errore nel caricamento:", error);
    }
}

// Inizializzazione
document.addEventListener('DOMContentLoaded', () => {
    // Inizializza icone
    lucide.createIcons();
    
    // Inizializza date picker
    initializeDatePicker();
    
    // Renderizza collaboratori
    renderCollaboratori();
    
    // Carica dati da Firebase
    loadFromFirebase();
    
    // Event listener per il calendario
    document.getElementById('generateCalendar').addEventListener('click', generateOutlookFile);
});
